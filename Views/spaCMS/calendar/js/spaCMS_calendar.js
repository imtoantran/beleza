function convert_num2dayval(e){switch(e){case"1":return 2;case"2":return 3;case"3":return 4;case"4":return 5;case"5":return 6;case"6":return 7;case"0":return 8;default:return!1}}function convert_Min2Hour(e){if(e=parseInt(e),!(1>e)){var t=Math.floor(e/60),n=e%60;10>t&&(t="0"+t),10>n&&(n="0"+n);var a=t+":"+n;return a}}function convert_Hour2Min(e){var t=null,n=null,a=null,i=null;return t=e.split(":"),n=parseInt(t[0]),a=parseInt(t[1]),i=60*n+a}var Calendar=function(){var e=$("#confirmedAppointment_modal"),t=($("#confirmedAppointment_form"),e.find(".edit_appointment_action")),n=e.find(".delete_appointment_action"),a=e.find(".complete_appointment_action"),i=e.find(".confirm_appointment_action"),r=$("#editConfirmedAppointment_modal"),o=$("#editConfirmedAppointment_form"),d=$("#addAppointment_modal"),_=$("#addAppointment_form"),c=r.find(".btnEdit_appointment_note"),s=function(){var r=new Date;r.setDate(r.getDate()-1),$("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:""},disableDragging:!0,defaultDate:moment(),editable:!0,eventLimit:!0,events:{url:URL+"spaCMS/calendar/xhrGet_calendar",error:function(){$("#script-warning").show()}},loading:function(e){$("#loading").toggle(e)},dayClick:function(e){_[0].reset();var t=$("input[name=appointment_date]",d),n=d.find(".appointment_date"),a=$("input[name=user_openHour]",d),i=$("input[name=user_closeHour]",d),r=convert_num2dayval(e.format("d")),o=null,c=null,s=null,l=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(l,function(d){return o=d[r][0],c=d[r][1],s=d[r][2],o?(t.val(e.format()),n.val(e.format("DD/MM/YYYY")),a.val(c),void i.val(s)):(jAlert("Không có lịch làm việc vào ngày này!"),!1)},"json").done(function(){o&&d.modal("show")})},eventClick:function(r){var o=e.find(".weekday"),d=e.find(".day"),_=e.find(".month"),c=e.find(".year"),s=e.find(".time"),l=e.find(".user_service_name"),u=e.find(".user_service_duration"),p=e.find(".user_service_price"),m=e.find(".status-unpaid"),f=e.find(".status-prepaid"),h=e.find(".status-paid"),v=e.find(".appointment-notes"),g=e.find(".status-uncomplete"),x=e.find(".status-complete"),M=e.find(".status-cancel"),C=e.find(".client_name"),Y=e.find(".client_phone"),b=e.find(".client_email"),y=e.find(".client_note"),S=e.find(".appointment_created"),k=e.find(".appointment_updated"),H=null,D=null,I=null;return r.a_id&&(D=r.a_id,I="appointment",H=URL+"spaCMS/calendar/xhrGet_appointment"),r.b_id&&(D=r.b_id,I="booking_detail",H=URL+"spaCMS/calendar/xhrGet_booking"),$.get(H,{data_id:D},function(r){"undefined"==typeof r[0]&&console.log("Không có data, có lẽ dữ liệu vào khiến sql gặp vấn đề");var H=new Date(r[0].data_date);o.text("Thứ "+(H.getDay()+1)),d.text(H.getDate()),_.text(H.getMonth()+1),c.text(H.getFullYear()),s.text(r[0].data_time_start.substr(0,5)),l.text(r[0].data_us_name),u.text(r[0].data_us_duration+" phút"),p.text($.number(r[0].data_price)+" đ"),""!=r[0].data_note?(v.find(".v-verification-notes").text(r[0].data_note),v.show()):v.hide(),Y.text(""!==r[0].data_client_phone?r[0].data_client_phone:"Chưa có số điện thoại"),C.text(r[0].data_client_name),Y.text(r[0].data_client_phone),b.text(r[0].data_client_email),y.text(r[0].data_client_note),0==r[0].data_status?(x.hide(),g.show(),M.hide()):1==r[0].data_status?(x.show(),g.hide(),M.hide()):(x.hide(),g.hide(),M.show()),"appointment"==I&&(m.hide(),f.hide(),h.show()),"booking_detail"==I&&(m.hide(),f.show(),h.hide());var D=e.find(".is_confirm_0"),U=e.find(".is_confirm_1");1==r[0].data_is_confirm?(D.hide(),U.show(),i.parent().hide()):(D.show(),U.hide(),i.parent().show()),0==r[0].data_status?(a.show(),i.show(),t.show(),n.show()):1==r[0].data_status&&(a.hide(),t.hide(),i.hide(),n.hide()),S.text(moment(r[0].data_created,"YYYY-MM-DD HH:mm:ss").format("DD/MM/YYYY HH:mm:ss")),k.text(moment(r[0].data_updated,"YYYY-MM-DD HH:mm:ss").format("DD/MM/YYYY HH:mm:ss")),t.attr("data_id",r[0].data_id),t.attr("data_type",I),n.attr("data_id",r[0].data_id),n.attr("data_type",I),n.attr("data_price",r[0].data_price),a.attr("data_id",r[0].data_id),a.attr("data_type",I),i.attr("data_id",r[0].data_id),i.attr("data_type",I),i.attr("client_email",r[0].data_client_email)},"json").done(function(){e.modal("show")}),!1},dayRender:function(e,t){r>e&&t.css("background-color","#F0F0F0")}})},l=function(){_.on("submit",function(){var e=$(this),t=e.serialize(),n=!1,a=e.find(".loading"),i=e.find(".done");a.fadeIn(),i.hide();var r=URL+"spaCMS/calendar/xhrInsert_appointment";return $.post(r,t,function(e){"success"==e&&(n=!0,$("#calendar").fullCalendar("refetchEvents"))}).done(function(){a.hide(),i.show(),n?d.modal("hide"):alert("insert appointment error!")}),!1})},u=function(){t.on("click",function(){var e=$(this),t=e.attr("data_id"),n=e.attr("data_type"),a=!1,i=e.find(".loading"),d=e.find(".done");i.fadeIn(),d.hide();var _=null;return"appointment"==n?_=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==n&&(_=URL+"spaCMS/calendar/xhrGet_booking"),$.get(_,{data_id:t},function(e){if(0==e.length)return!1;a=!0;var i=$(".edit_client_action"),d=null,_=r.find(".client_name"),s=r.find(".client_phone"),l=$("input[name=client_email]",r),u=r.find(".client_email"),p=r.find(".client_note"),m=$("select[name=user_service_service_id]",r),f=$("input[name=appointment_price]",r),h=$("input[name=appointment_date]",r),v=r.find(".appointment_date"),g=$("input[name=appointment_time_start]",r),x=r.find(".user_service_time_start"),M=$("input[name=appointment_time_end]",r),C=r.find(".appointment_time_end"),Y=r.find(".user_service_duration"),b=$("textarea[name=appointment_note]",r);_.text(e[0].data_client_name),s.text(e[0].data_client_phone),l.val(e[0].data_client_email),u.text(e[0].data_client_email),p.text(e[0].data_client_note),f.val(e[0].data_price),h.val(e[0].data_date),v.val(moment(e[0].data_date,"YYYY-MM-DD").format("DD-MM-YYYY")),g.val(e[0].data_time_start),x.text(e[0].data_time_start.substr(0,5)),M.val(e[0].data_time_end),C.text(e[0].data_time_end.substr(0,5)),Y.text(e[0].data_us_duration),b.val(e[0].data_note),m.find('option[value="'+e[0].data_us_id+'"]').prop("selected",!0),"appointment"==n?(d=e[0].data_id,i.show(),i.attr("data_id",d),i.attr("data_type",n)):i.hide(),$("input[name=data_id]",o).val(t),$("input[name=data_type]",o).val(n),c.attr("data_id",t),c.attr("data_type",n);var y=$("input[name=user_openHour]",o),S=$("input[name=user_closeHour]",o),k=moment(h.val(),"YYYY-MM-DD"),H=convert_num2dayval(k.format("d")),D=null,I=null,U=null,w=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(w,function(e){D=e[H][0],I=e[H][1],U=e[H][2],y.val(I),S.val(U);var t=r.find(".appointment_time_start");t.hide();var n='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',a='<option value="">Chọn giờ</option>',i=$("select[name=user_service_service_id]",r).val(),o=$("input[name=appointment_date]",r).val(),d=r.find(".user_service_duration").text();d=parseInt(d);var _=60*I,c=60*U,s=_,l=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(l,{us_id:i,date:o},function(e){for(var i=e.user_service_limit_booking;c>s;){var r=!1,o=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);s>=n&&a>s&&o++}}),o>=i&&(r=!0),timeStart_hourValue=convert_Min2Hour(s),a+=n.replace(/:appointment_time_start/g,timeStart_hourValue),a=r?a.replace(":isScheduled",'disabled="disabled" style="color:red"'):a.replace(":isScheduled",""),s+=d}t.html(a)},"json").done(function(){t.fadeIn()})},"json")},"json").done(function(){if(i.hide(),d.show(),a){var e=r.find(".vus_time_start");e.css("color","#000"),r.modal("show")}else alert("Open editConfirmedAppointment popup error!")}),!1})},p=function(){o.on("submit",function(){var t=$(this),n=!1,a=t.find(".loading"),i=t.find(".done"),o=t.find(".b-service-not-exist"),d=t.find(".appointment_date").val();d=moment(d,"DD-MM-YYYY");var _=convert_num2dayval(d.format("d")),c=null,s="";return s="booking_detail"===this.data_type.value?"Cập nhật lịch hẹn mới và gửi email thông báo cho khách hàng?":"Cập nhật lịch hẹn?",jConfirm(s,"Cập nhật lịch hẹn",function(d){if(1==d){o.fadeOut(),a.fadeIn(),i.hide();var s=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(s,function(d){if(c=d[_][0],!c)return o.fadeIn(),a.hide(),i.show(),!1;var d=t.serialize();$.ajax({url:URL+"spaCMS/calendar/xhrGetTimeAutoConfirmSpa",type:"post"}).done(function(t){var o=t,_=URL+"spaCMS/calendar/xhrUpdate_appointment";d+="&appointment_time_confirm="+o,$.post(_,d,function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),n=!0)}).done(function(){a.hide(),i.show(),n?(r.modal("hide"),e.modal("hide"),jAlert("Cập nhật thành công!")):alert("Update appointment error!")})})},"json")}}),!1}),i.on("click",function(){var t=$(this),n=e.find(".is_confirm_0"),a=e.find(".is_confirm_1"),r=!1,o=t.find(".loading"),d=t.find(".done"),_=t.attr("data_id"),c=t.attr("data_type"),s=t.attr("client_email");jConfirm("Xác thực lịch hẹn này?","Xác thực lịch hẹn",function(e){if(1==e){o.fadeIn(),d.hide();var t=URL+"spaCMS/calendar/xhrUpdate_appointment_is_confirm";$.post(t,{data_id:_,data_type:c,client_email:s},function(e){"success"==e&&(r=!0)}).done(function(){o.hide(),d.show(),r?(n.hide(),a.hide(),a.fadeIn(),i.fadeOut()):alert("Confirmed appointment error!")})}})}),a.on("click",function(){var r=$(this),o=r.attr("data_id"),d=r.attr("data_type"),_=!1,c=r.find(".loading"),s=r.find(".done");jConfirm("Bạn có chắc đã hoàn thành lịch hẹn này?","Hoàn thành lịch hẹn",function(r){if(1==r){c.fadeIn(),s.hide();var l=!1,u=URL+"spaCMS/calendar/xhrCheck_appointment_is_confirmed";$.post(u,{data_id:o,data_type:d},function(r){if("success"!=r)return!1;l=!0;var c=e.find(".status-uncomplete"),s=e.find(".status-complete"),u=e.find(".status-cancel"),p=URL+"spaCMS/calendar/xhrUpdate_appointment_status";$.post(p,{data_id:o,data_type:d},function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),_=!0)}).done(function(){_?(c.hide(),s.fadeIn(),u.hide(),a.fadeOut(),t.fadeOut(),n.fadeOut(),i.hide()):(c.fadeIn(),s.hide(),u.hide(),alert("Update appointment status error"))})}).done(function(){return c.hide(),s.show(),0==l?(alert("Chưa thể hoàn thành khi lịch hẹn của bạn chưa được xác thực!"),!1):void 0})}})}),c.on("click",function(){var e=$(this),t=e.attr("data_id"),n=e.attr("data_type"),a=$("textarea[name=appointment_note]",o).val(),i={data_id:t,data_type:n,appointment_note:a},r=!1,d=e.find(".loading"),_=e.find(".done");d.fadeIn(),_.hide();var c=URL+"spaCMS/calendar/xhrUpdate_appointment_note";$.post(c,i,function(e){"success"==e&&(r=!0)}).done(function(){d.hide(),_.show(),r||alert("update appointment note error!")})})},m=function(){n.on("click",function(){var t=$(this),n=t.attr("data_id"),a=t.attr("data_type"),i={data_id:n,data_type:a},r=!1,o=t.find(".loading"),d=t.find(".done"),_="";if("booking_detail"==a){var c=t.attr("data_price"),s=parseInt(c)/1e4;_="Bạn có muốn hủy lịch hẹn này? <br/> Khách hàng sẽ nhận được "+s+" credit point."}else _="Bạn có muốn hủy lịch hẹn này?";return jConfirm(_,"Hủy lịch hẹn",function(t){if(1==t){o.fadeIn(),d.hide();var n=URL+"spaCMS/calendar/xhrDelete_appointment";$.post(n,i,function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),r=!0)}).done(function(){o.hide(),d.show(),r?e.modal("hide"):alert("Can not cancel appointment!")})}}),!1})},f=function(){var e=$("#editConfirmedAppointment_form").find(".edit_client_action"),t=$("#editClient_modal");e.on("click",function(){var e=$(this),n=e.attr("data_id"),a=e.attr("data_type"),i=!1,r=e.find(".e-loading");r.fadeIn();var o=null;return"appointment"==a?o=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==a&&(o=URL+"spaCMS/calendar/xhrGet_booking"),$.get(o,{data_id:n},function(e){if(0==e.length)return!1;i=!0;var r=$("input[name=client_name]",t),o=$("input[name=client_phone]",t),d=$("input[name=client_email]",t),_=$("input[name=client_sex]",t),c=$("input[name=client_birth]",t),s=$("textarea[name=client_note]",t);r.val(e[0].data_client_name),o.val(e[0].data_client_phone),d.val(e[0].data_client_email),_.filter('[value="'+e[0].data_client_sex+'"]').prop("checked",!0),c.val(e[0].data_client_birth),s.val(e[0].data_client_note),$("input[name=data_id]",t).val(n),$("input[name=data_type]",t).val(a)},"json").done(function(){r.hide(),i?t.modal("show"):alert("Can not open edit client form!")}),!1})},h=function(){var e=$("#editClient_modal"),t=$("#editConfirmedAppointment_form"),n=t.find(".client_name"),a=t.find(".client_phone"),i=t.find(".client_note"),r=t.find(".client_email");$("#editClient_form").on("submit",function(){var t=$(this),o=t.serialize(),d=!1,_=t.find(".loading"),c=t.find(".done");_.fadeIn(),c.hide();var s=URL+"spaCMS/calendar/xhrUpdate_appointment_client";return $.post(s,o,function(t){"success"==t&&($("#calendar").fullCalendar("refetchEvents"),n.hide(),a.hide(),i.hide(),r.hide(),n.text($("input[name=client_name]",e).val()),a.text($("input[name=client_phone]",e).val()),i.text($("textarea[name=client_note]",e).val()),r.text($("input[name=client_email]",e).val()),n.fadeIn(),a.fadeIn(),r.fadeIn(),i.fadeIn(),d=!0)}).done(function(){_.hide(),c.show(),d?e.modal("hide"):alert("Update client error!")}),!1})},v=function(){var e=$(".list_gus");e.html('<option value="">Chọn dịch vụ</option>');var t='<optgroup data-id=":group_service_id" label=":group_service_name">';t+=":list_user_service",t+="</optgroup>";var n='<option value=":user_service_id">:user_service_name</option>';n+=":list_user_service";var a=URL+"spaCMS/menu/xhrGet_group_user_service",i="",r=$.get(a,function(a){$.each(a,function(a,r){i=t.replace(":group_service_id",r.group_service_id),i=i.replace(":group_service_name",r.group_service_name),"undefined"!=typeof r.list_user_service&&$.each(r.list_user_service,function(e,t){i=i.replace(":list_user_service",n),i=i.replace(":user_service_id",t.user_service_id),i=i.replace(":user_service_name",t.user_service_name)}),i=i.replace(":list_user_service",""),e.append(i)})},"json");return r},g=function(){var e=d.find(".list_gus"),t=d.find(".appointment_time_start"),n=d.find(".user_service_duration"),a=$("input[name=appointment_price]",d),i=$("input[name=appointment_time_end]",d),r=d.find(".appointment_time_end"),o='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',_=null;e.on("change",function(){var e=$(this),c=e.val(),s=null,l=null,u=null,p=null;if(""===c)return!1;t.hide(),_="";var m=$("input[name=appointment_date]",d).val(),f=$("input[name=user_openHour]",d).val(),h=$("input[name=user_closeHour]",d).val(),v=URL+"spaCMS/calendar/xhrGet_user_service";$.get(v,{user_service_id:c},function(e){l=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,s=e[0].user_service_duration,s=parseInt(s);var n=60*f,a=60*h,d=n,v=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(v,{us_id:c,date:m},function(e){for(var t=e.user_service_limit_booking;a>d;){var n=!1,i=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);d>=n&&a>d&&i++}}),i>=t&&(n=!0),timeStart_hourValue=convert_Min2Hour(d),_+=o.replace(/:appointment_time_start/g,timeStart_hourValue),_=n?_.replace(":isScheduled",'disabled="disabled" style="color:red"'):_.replace(":isScheduled",""),d+=s}},"json").done(function(){t.html(_),t.fadeIn(),p=convert_Hour2Min(t.val()),u=convert_Min2Hour(p+s),r.text(u),i.val(u)})},"json").done(function(){n.text(s),a.val(l)})})},x=function(){var e=r.find(".list_gus"),t=r.find(".appointment_time_start"),n=r.find(".user_service_duration"),a=$("input[name=appointment_price]",r),i=$("input[name=appointment_time_end]",r),d=r.find(".appointment_time_end"),_='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',c=null;e.on("change",function(){var e=$(this),o=r.find(".vus_time_start");o.css("color","#CCC");var s=e.val(),l=null,u=null,p=null,m=null;if(""===s)return!1;t.hide(),c="";var f=$("input[name=appointment_date]",r).val(),h=$("input[name=user_openHour]",r).val(),v=$("input[name=user_closeHour]",r).val(),g=URL+"spaCMS/calendar/xhrGet_user_service";$.get(g,{user_service_id:s},function(e){u=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,l=e[0].user_service_duration,l=parseInt(l);var n=60*h,a=60*v,o=n,g=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(g,{us_id:s,date:f},function(e){for(var t=e.user_service_limit_booking;a>o;){var n=!1,i=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);o>=n&&a>o&&i++}}),i>=t&&(n=!0),timeStart_hourValue=convert_Min2Hour(o),c+=_.replace(/:appointment_time_start/g,timeStart_hourValue),c=n?c.replace(":isScheduled",'disabled="disabled" style="color:red"'):c.replace(":isScheduled",""),o+=l}},"json").done(function(){t.html(c),t.fadeIn(),m=convert_Hour2Min(t.val()),p=convert_Min2Hour(m+l),d.text(p),i.val(p),$("input[name=appointment_time_start]",r).val(t.val())})},"json").done(function(){n.text(l),a.val(u)})}),r.find(".appointment_date").datepicker({language:"vi",autoclose:!0}).on("changeDate",function(){var e=$(this),s=e.val();""==s&&(s=$("input[name=appointment_date]").val(),s=moment(s,"YYYY-MM-DD"));var l=r.find(".vus_time_start");l.css("color","#CCC");var u=moment(s,"DD-MM-YYYY"),p=$("select[name=user_service_service_id]",o).val(),m=$("input[name=appointment_date]",r);m.val(u.format("YYYY-MM-DD")),t.hide(),c="";var f=convert_num2dayval(u.format("d")),h=null,v=null,g=null,x=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(x,function(e){if(h=e[f][0],v=e[f][1],g=e[f][2],!h)return alert("Không có lịch làm việc vào ngày này, hãy chọn ngày khác!"),!1;var o=($("input[name=user_openHour]",r).val(v),$("input[name=user_closeHour]",r).val(g),URL+"spaCMS/calendar/xhrGet_user_service");$.get(o,{user_service_id:p},function(e){us_price=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,us_duration=e[0].user_service_duration,us_duration=parseInt(us_duration);var n=60*v,a=60*g,o=n,s=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(s,{us_id:p,date:u.format("YYYY-MM-DD")},function(e){for(var t=e.user_service_limit_booking;a>o;){var n=!1,i=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);o>=n&&a>o&&i++}}),i>=t&&(n=!0),timeStart_hourValue=convert_Min2Hour(o),c+=_.replace(/:appointment_time_start/g,timeStart_hourValue),c=n?c.replace(":isScheduled",'disabled="disabled" style="color:red"'):c.replace(":isScheduled",""),o+=us_duration}},"json").done(function(){t.html(c),t.fadeIn(),app_time_start=convert_Hour2Min(t.val()),app_time_end=convert_Min2Hour(app_time_start+us_duration),d.text(app_time_end),i.val(app_time_end),$("input[name=appointment_time_start]",r).val(t.val())})},"json").done(function(){n.text(us_duration),a.val(us_price)})},"json").done(function(){})}),$("body").removeClass("modal-open")},M=function(){var e=d.find(".appointment_time_start");e.change(function(){var e=$(this),t=e.val(),n=null,a=d.find(".user_service_duration").text();a=parseInt(a);var i=convert_Hour2Min(t),r=i+a,n=convert_Min2Hour(r),o=d.find(".appointment_time_end");o.text(n),$("input[name=appointment_time_end]",d).val(n)})},C=function(){var e=r.find(".appointment_time_start");e.change(function(){var e=$(this),t=e.val(),n=null;""==t&&(app_time_start_old=r.find(".user_service_time_start").text(),t=app_time_start_old);var a=r.find(".user_service_duration").text();a=parseInt(a);var i=r.find(".vus_time_start");i.css("color","#CCC");var o=convert_Hour2Min(t),d=o+a,n=convert_Min2Hour(d),_=r.find(".appointment_time_end");_.text(n),$("input[name=appointment_time_end]",r).val(n),$("input[name=appointment_time_start]",r).val(t)})};return{init:function(){s(),l(),m(),u(),p(),f(),h(),v(),g(),x(),M(),C()}}}(),redeemVoucher=function(){var e=$("#redeemVoucher_modal"),t=e.find(".voucher-start"),n=e.find(".voucher-searching"),a=e.find(".voucher-not-found"),i=e.find(".voucher-info"),r=e.find(".voucher-redeem-success"),o=e.find(".redeem-action"),d=$("#redeem");d.on("click",function(){s(),t.show(),e.modal("show")}),e_voucher_status_1=e.find(".e_voucher_status_1"),e_voucher_status_0=e.find(".e_voucher_status_0");var _=function(){$("#redeemVoucher_form").on("submit",function(){var r=$(this);s();var d=$("input[name=e_voucher_id]",r).val();d=d.replace(/-/g,""),d=d.insert(1,"-");var _=!1,c=URL+"spaCMS/home/xhrGet_redeem_voucher";return $.post(c,{e_voucher_id:d},function(a){if(t.hide(),n.show(),0==a.length)return _=!0,!1;var i=e.find(".booking_id"),r=e.find(".client_name"),d=e.find(".client_phone"),c=e.find(".user_service_name"),s=e.find(".e_voucher_due_date"),l=e.find(".e_voucher_price");i.text(a[0].booking_id),r.text(a[0].client_name),d.text(a[0].client_phone),c.text(a[0].user_service_name),s.text(moment(a[0].e_voucher_due_date,"YYYY-MM-DD").format("DD-MM-YYYY")),l.text($.number(a[0].e_voucher_price)+" vnđ"),0==a[0].e_voucher_status?(e_voucher_status_0.show(),e_voucher_status_1.hide(),o.attr("data_id",a[0].e_voucher_id),o.fadeIn()):(e_voucher_status_0.hide(),e_voucher_status_1.show(),o.hide())},"json").done(function(){_?(n.hide(),a.fadeIn(),i.hide()):(n.hide(),a.hide(),i.fadeIn())}),!1})},c=function(){o.on("click",function(){var e=confirm("Xác thực evoucher này?");if(1==e){var t=$(this),n=t.attr("data_id"),a=t.find(".loading"),i=t.find(".done");a.fadeIn(),i.hide();var o=URL+"spaCMS/home/xhrUpdate_e_voucher";$.post(o,{data_id:n},function(e){"success"==e&&(s(),r.fadeIn())}).done(function(){a.hide(),i.fadeIn()})}return!1})},s=function(){t.hide(),n.hide(),a.hide(),i.hide(),r.hide(),o.hide()};return{init:function(){_(),c()}}}(),Calendar_Search=function(){var e=function(){function e(e){var c=$("#search_loader");c.fadeIn(),_.hide(),d.hide(),d.html("");var s=URL+"spaCMS/calendar/xhrGet_calendar_search";$.get(s,{search_string:e},function(_){if(_.length>0){var c="";$.each(_,function(o,_){var s=_.data_client_name.replace(e,"<b class='highlight'>"+e+"</b>"),l=_.data_client_phone.replace(e,"<b class='highlight'>"+e+"</b>"),u=_.data_booking_id.replace(e,"<b class='highlight'>"+e+"</b>");c=t.replace(":status_type","appointment"==_.data_type?n:a),c=c.replace(":status_is_confirm",1==_.data_is_confirm?i:""),c=c.replace(":status_is_done",1==_.data_status?r:""),c=c.replace(":client_name",s),c=c.replace(":client_phone",l),c=c.replace(":appointment_date",moment(_.data_date,"YYYY-MM-DD").format("DD/MM/YYYY")),c=c.replace(":appointment_time_start",_.data_time_start.substr(0,5)),c=c.replace(":booking_id",u),c=c.replace(":user_service_name",_.data_us_name),d.append(c)})}else d.append(o)},"json").done(function(){c.fadeOut(),_.show(),d.fadeIn()})}var t='<li class="ui-menu-item" role="menuitem"><a href="#" class="ui-corner-all" tabindex="-1">:status_type:status_is_confirm:status_is_done<span class="name">:client_name</span><span class="info phone">:client_phone</span><span class="info">:appointment_date - :appointment_time_start</span><span class="info">:booking_id</span><span class="info">:user_service_name</span></a></li>',n='<span class="icon fa fa-font"></span>',a='<span class="icon fa fa-bold"></span>',i='<span class="is_confirm fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x "></i><i class="fa fa-stack-1x fa-inverse">X</i></span>',r='<span class="is_done fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x "></i><i class="fa fa-stack-1x fa-inverse">H</i></span>',o="<li>Không tìm thấy kết quả phù hợp!</li>",d=$("ul#search_results"),_=$(".clear-search"),c=$("#calendar_search");c.on("change",function(){clearTimeout($.data(this,"timer"));var t=$(this).val();t.length>2?$(this).data("timer",setTimeout(e(t),1e3)):d.fadeOut()}),_.on("click",function(){d.html(""),d.fadeOut(),c.val(""),$(this).hide()})},t=function(){function e(e){n.show(),t.hide(),t.html("");var i=!1,r=URL+"spaCMS/calendar/xhrGet_appointment_client_name";$.get(r,{search_string:e},function(e){e.length>0&&(t.html(e),i=!0)}).done(function(){n.hide(),i&&t.fadeIn();var e=$("#results_search_a_client_name").find("li.ui-menu-item");e.on("click",function(){var e=$(this),n=e.text();a.val(n),t.hide()})})}var t=$("#results_search_a_client_name").find("ul"),n=$(".search_a_client_name"),a=$("#appointment_client_name");a.on("keyup",function(){clearTimeout($.data(this,"timer"));var n=$(this).val();n.length>2?$(this).data("timer",setTimeout(e(n),100)):t.fadeOut()})};return{init:function(){e(),t()}}}();$(document).ready(function(){$(".btnAct_refresh_calendar").on("click",function(){return $("#calendar").fullCalendar("refetchEvents"),!1}),$("#e_voucher_id").inputmask("A-****-****",{placeholder:"_-____-____",clearMaskOnLostFocus:!0}),String.prototype.insert=function(e,t){return e>0?this.substring(0,e)+t+this.substring(e,this.length):t+this},Calendar.init(),Calendar_Search.init(),redeemVoucher.init(),$(".fc-today-button").text("Hôm nay")});
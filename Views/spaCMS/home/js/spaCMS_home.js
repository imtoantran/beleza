function convert_num2dayval(e){switch(e){case"1":return 2;case"2":return 3;case"3":return 4;case"4":return 5;case"5":return 6;case"6":return 7;case"0":return 8;default:return!1}}function convert_Min2Hour(e){if(e=parseInt(e),!(1>e)){var t=Math.floor(e/60),n=e%60;10>t&&(t="0"+t),10>n&&(n="0"+n);var a=t+":"+n;return a}}function convert_Hour2Min(e){var t=null,n=null,a=null,i=null;return t=e.split(":"),n=parseInt(t[0]),a=parseInt(t[1]),i=60*n+a}$(document).ready(function(){$("#bookings, #venue, #phone , #sale").tooltip({placement:"top",html:!0,container:"body",delay:0}),$("#e_voucher_id").inputmask("A-****-****",{placeholder:"_-____-____",clearMaskOnLostFocus:!0}),$("#g_voucher_code").inputmask("A-****-****",{placeholder:"_-____-____",clearMaskOnLostFocus:!0}),String.prototype.insert=function(e,t){return e>0?this.substring(0,e)+t+this.substring(e,this.length):t+this},Home.init(),redeemVoucher.init(),redeemGvoucher.init()});var redeemVoucher=function(){var e=$("#redeemVoucher_modal"),t=e.find(".voucher-start"),n=e.find(".voucher-searching"),a=e.find(".voucher-not-found"),i=e.find(".voucher-info"),o=e.find(".voucher-redeem-success"),r=e.find(".redeem-action"),d=$("#redeem");d.on("click",function(){u(),t.show(),e.modal("show")}),e_voucher_status_1=e.find(".e_voucher_status_1"),e_voucher_status_0=e.find(".e_voucher_status_0");var _=function(){$("#redeemVoucher_form").on("submit",function(){var o=$(this);u();var d=$("input[name=e_voucher_id]",o).val();d=d.replace(/-/g,""),d=d.insert(1,"-");var _=!1,c=URL+"spaCMS/home/xhrGet_redeem_voucher";return $.post(c,{e_voucher_id:d},function(a){if(t.hide(),n.show(),0==a.length)return _=!0,!1;var i=e.find(".booking_id"),o=e.find(".client_name"),d=e.find(".client_phone"),c=e.find(".user_service_name"),u=e.find(".e_voucher_due_date"),s=e.find(".e_voucher_price");i.text(a[0].booking_id),o.text(a[0].client_name),d.text(a[0].client_phone),c.text(a[0].user_service_name),u.text(moment(a[0].e_voucher_due_date,"YYYY-MM-DD").format("DD/MM/YYYY")),s.text($.number(a[0].e_voucher_price)+" vnđ"),0==a[0].e_voucher_status?(e_voucher_status_0.show(),e_voucher_status_1.hide(),r.attr("data_id",a[0].e_voucher_id),r.fadeIn()):(e_voucher_status_0.hide(),e_voucher_status_1.show(),r.hide())},"json").done(function(){_?(n.hide(),a.fadeIn(),i.hide()):(n.hide(),a.hide(),i.fadeIn())}),!1})},c=function(){r.on("click",function(){var e=confirm("Xác thực evoucher này?");if(1==e){var t=$(this),n=t.attr("data_id"),a=t.find(".loading"),i=t.find(".done");a.fadeIn(),i.hide();var r=URL+"spaCMS/home/xhrUpdate_e_voucher";$.post(r,{data_id:n},function(e){"success"==e&&(u(),o.fadeIn())}).done(function(){a.hide(),i.fadeIn()})}return!1})},u=function(){t.hide(),n.hide(),a.hide(),i.hide(),o.hide(),r.hide()};return{init:function(){_(),c()}}}(),redeemGvoucher=function(){var e=$("#redeemGvoucher_modal"),t=$("#redeemGvoucher_form"),n=$("#redeem_gvoucher"),a=e.find(".redeem-action"),i=e.find(".voucher-start"),o=e.find(".voucher-searching"),r=e.find(".voucher-not-found"),d=e.find(".voucher-info"),_=e.find(".voucher-redeem-success");n.on("click",function(){s(),i.show(),e.modal("show")}),g_voucher_status_1=e.find(".g_voucher_status_1"),g_voucher_status_0=e.find(".g_voucher_status_0");var c=function(){t.on("submit",function(){var t=$(this);s();var n=$("input[name=g_voucher_code]",t).val();n=n.replace(/-/g,""),n=n.insert(1,"-");var _=!1,c=URL+"spaCMS/home/xhrGet_redeem_gvoucher";return $.post(c,{g_voucher_code:n},function(t){if(i.hide(),o.show(),null==t)return _=!0,!1;var n=e.find(".gift_voucher_code"),r=e.find(".gift_voucher_price"),d=e.find(".gift_voucher_due_date"),c=e.find(".gift_voucher_email"),u=e.find(".gift_voucher_date");n.text(t.gift_voucher_code),r.text($.number(t.gift_voucher_price)+" vnđ"),u.text(moment(t.gift_voucher_date,"YYYY-MM-DD").format("DD/MM/YYYY")),d.text(moment(t.gift_voucher_due_date,"YYYY-MM-DD").format("DD/MM/YYYY")),c.text(t.gift_voucher_email),0==t.gift_voucher_status?(g_voucher_status_0.show(),g_voucher_status_1.hide(),a.attr("data_id",t.gift_voucher_id),a.fadeIn()):(g_voucher_status_0.hide(),g_voucher_status_1.show(),a.hide())},"json").done(function(){_?(o.hide(),r.fadeIn(),d.hide()):(o.hide(),r.hide(),d.fadeIn())}),!1})},u=function(){a.on("click",function(){var e=$(this),t={data_id:e.attr("data_id")},n=!1,a=e.find(".loading"),i=e.find(".done");jConfirm("Xác thực gift voucher này?","Xác thực gift voucher",function(e){if(1==e){a.fadeIn(),i.hide();var o=URL+"spaCMS/home/xhrUpdate_gift_voucher";$.post(o,t,function(e){"success"==e&&(s(),_.fadeIn(),n=!0)}).done(function(){a.hide(),i.show(),n||jAlert("Update gift voucher error!")})}})})},s=function(){i.hide(),o.hide(),r.hide(),d.hide(),_.hide(),a.hide()};return{init:function(){c(),u()}}}(),Home=function(){var e=$("#confirmedAppointment_modal"),t=($("#confirmedAppointment_form"),e.find(".edit_appointment_action")),n=e.find(".delete_appointment_action"),a=e.find(".complete_appointment_action"),i=e.find(".confirm_appointment_action"),o=$("#editConfirmedAppointment_modal"),r=$("#editConfirmedAppointment_form"),d=($("#addAppointment_modal"),$("#addAppointment_form"),function(){var e=$("#monthly-sales"),t=e.find(".v-bookings"),n=e.find(".v-ttv"),a=e.find(".v-evouchers"),i=e.find(".v-tte"),o=moment().startOf("month").format("YYYY-MM-DD"),r=moment().endOf("month").format("YYYY-MM-DD"),d=URL+"spaCMS/home/xhrGet_monthly_sales";$.get(d,{this_month_from:o,this_month_to:r},function(e){t.text(e.total_booking_count),n.text($.number(e.total_booking_value)+" đ"),a.text(e.total_evoucher_count),i.text($.number(e.total_evoucher_value)+" đ")},"json").done(function(){t.fadeOut(),n.fadeOut(),a.fadeOut(),i.fadeOut(),t.fadeIn(),n.fadeIn(),a.fadeIn(),i.fadeIn()})}),_=function(){var e=$("#top-services").find(".list-top-services-booking"),t=$("#top-services").find(".list-top-services-evoucher"),n="<tr><th>:us_name</th><td>:total_book</td></tr>",a=URL+"spaCMS/home/xhrGet_top_services_booking";$.get(a,function(t){var a="";$.each(t,function(t,i){a=n.replace(":us_name",i.user_service_name),a=a.replace(":total_book",i.total_book),e.append(a)})},"json").done(function(){e.fadeOut(),e.fadeIn()});var a=URL+"spaCMS/home/xhrGet_top_services_evoucher";$.get(a,function(e){var a="";$.each(e,function(e,i){a=n.replace(":us_name",i.user_service_name),a=a.replace(":total_book",i.total_evoucher),t.append(a)})},"json").done(function(){t.fadeOut(),t.fadeIn()})},c=function(){var e=$(".v-count"),t=$("#list_appointment_not_confirm"),n='<tr class="empty" :data_id><td> :data_us_name </td><td> :data_client_name </td><td> Ngày :data_date, :data_time_start </td><td> :data_type </td></tr>';label_0="",label_1="";var a="",i=URL+"spaCMS/home/xhrGet_appointment_not_confirm";$.get(i,function(i){var o=i.length;o>0&&(t.html(""),$.each(i,function(e,i){a=n.replace(":data_us_name",i.data_us_name),a=a.replace(":data_client_name",i.data_client_name),a=a.replace(":data_date",moment(i.data_date,"YYYY-MM-DD").format("DD-MM-YYYY")),a=a.replace(":data_time_start",i.data_time_start.substr(0,5)),a=a.replace(":data_type","a"==i.data_type?"Appointment":"Bookings"),a=a.replace(":data_id","a"==i.data_type?'a_id="'+i.data_id+'"':'b_id="'+i.data_id+'"'),t.append(a)})),e.text(o)},"json").done(function(){e.fadeOut(),e.fadeIn(),u()})},u=function(){var o=$("#list_appointment_not_confirm").find("tr");o.on("click",function(){var o=$(this),r=o.attr("a_id"),d=o.attr("b_id"),_=e.find(".weekday"),c=e.find(".day"),u=e.find(".month"),s=e.find(".year"),l=e.find(".time"),p=e.find(".user_service_name"),m=e.find(".user_service_duration"),h=e.find(".user_service_price"),f=e.find(".status-unpaid"),v=e.find(".status-prepaid"),g=e.find(".status-paid"),M=e.find(".appointment-notes"),x=e.find(".status-uncomplete"),Y=e.find(".status-complete"),C=e.find(".status-cancel"),b=e.find(".client_name"),y=e.find(".client_phone"),D=e.find(".client_email"),k=e.find(".client_note"),S=e.find(".appointment_created"),I=e.find(".appointment_updated"),U=null,w=null,H=null;return r&&(w=r,H="appointment",U=URL+"spaCMS/calendar/xhrGet_appointment"),d&&(w=d,H="booking_detail",U=URL+"spaCMS/calendar/xhrGet_booking"),$.get(U,{data_id:w},function(o){"undefined"==typeof o[0]&&console.log("Không có data, có lẽ dữ liệu vào khiến sql gặp vấn đề");var r=new Date(o[0].data_date);_.text("Thứ "+(r.getDay()+1)),c.text(r.getDate()),u.text(r.getMonth()+1),s.text(r.getFullYear()),l.text(o[0].data_time_start.substr(0,5)),p.text(o[0].data_us_name),m.text(o[0].data_us_duration+" phút"),h.text($.number(o[0].data_price)+" đ"),""!=o[0].data_note?(M.find(".v-verification-notes").text(o[0].data_note),M.show()):M.hide(),y.text(""!==o[0].data_client_phone?o[0].data_client_phone:"Chưa có số điện thoại"),b.text(o[0].data_client_name),y.text(o[0].data_client_phone),D.text(o[0].data_client_email),k.text(o[0].data_client_note),0==o[0].data_status?(Y.hide(),x.show(),C.hide()):1==o[0].data_status?(Y.show(),x.hide(),C.hide()):(Y.hide(),x.hide(),C.show()),"appointment"==H&&(f.hide(),v.hide(),g.show()),"booking_detail"==H&&(f.hide(),v.show(),g.hide());var d=e.find(".is_confirm_0"),U=e.find(".is_confirm_1");1==o[0].data_is_confirm?(d.hide(),U.show(),i.parent().hide()):(d.show(),U.hide(),i.parent().show()),0==o[0].data_status?(a.show(),i.show(),t.show(),n.show()):1==o[0].data_status&&(a.hide(),t.hide(),i.hide(),n.hide()),S.text(moment(o[0].data_created,"YYYY-MM-DD HH:mm:ss").format("DD/MM/YYYY HH:mm:ss")),I.text(moment(o[0].data_updated,"YYYY-MM-DD HH:mm:ss").format("DD/MM/YYYY HH:mm:ss")),t.attr("data_id",o[0].data_id),t.attr("data_type",H),n.attr("data_id",o[0].data_id),n.attr("data_type",H),n.attr("data_price",o[0].data_price),a.attr("data_id",o[0].data_id),a.attr("data_type",H),i.attr("data_id",o[0].data_id),i.attr("data_type",H),i.attr("client_email",o[0].data_client_email)},"json").done(function(){e.modal("show")}),!1});var r=URL+"spaCMS/home/xhrGetOM_appointment_for_edit";$.get(r,function(e){e.length>0},"json").done(function(){})},s=function(){t.on("click",function(){var e=$(this),t=e.attr("data_id"),n=e.attr("data_type"),a=!1,i=e.find(".loading"),d=e.find(".done");i.fadeIn(),d.hide();var _=null;return"appointment"==n?_=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==n&&(_=URL+"spaCMS/calendar/xhrGet_booking"),$.get(_,{data_id:t},function(e){if(0==e.length)return!1;a=!0;var i=$(".edit_client_action"),d=null,_=o.find(".client_name"),c=o.find(".client_phone"),u=$("input[name=client_email]",o),s=o.find(".client_email"),l=o.find(".client_note"),p=$("select[name=user_service_service_id]",o),m=$("input[name=appointment_price]",o),h=$("input[name=appointment_date]",o),f=o.find(".appointment_date"),v=$("input[name=appointment_time_start]",o),g=o.find(".user_service_time_start"),M=$("input[name=appointment_time_end]",o),x=o.find(".appointment_time_end"),Y=o.find(".user_service_duration"),C=$("textarea[name=appointment_note]",o);_.text(e[0].data_client_name),c.text(e[0].data_client_phone),u.val(e[0].data_client_email),s.text(e[0].data_client_email),l.text(e[0].data_client_note),m.val(e[0].data_price),h.val(e[0].data_date),f.val(moment(e[0].data_date,"YYYY-MM-DD").format("DD-MM-YYYY")),v.val(e[0].data_time_start),g.text(e[0].data_time_start.substr(0,5)),M.val(e[0].data_time_end),x.text(e[0].data_time_end.substr(0,5)),Y.text(e[0].data_us_duration),C.val(e[0].data_note),p.find('option[value="'+e[0].data_us_id+'"]').prop("selected",!0),"appointment"==n?(d=e[0].data_id,i.show(),i.attr("data_id",d),i.attr("data_type",n)):i.hide(),$("input[name=data_id]",r).val(t),$("input[name=data_type]",r).val(n);var b=$("input[name=user_openHour]",r),y=$("input[name=user_closeHour]",r),D=moment(h.val(),"YYYY-MM-DD"),k=convert_num2dayval(D.format("d")),S=null,I=null,U=null,w=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(w,function(e){S=e[k][0],I=e[k][1],U=e[k][2],b.val(I),y.val(U);var t=o.find(".appointment_time_start");t.hide();var n='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',a='<option value="">Chọn giờ</option>',i=$("select[name=user_service_service_id]",o).val(),r=$("input[name=appointment_date]",o).val(),d=o.find(".user_service_duration").text();d=parseInt(d);var _=60*I,c=60*U,u=_,s=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(s,{us_id:i,date:r},function(e){for(var i=e.user_service_limit_booking;c>u;){var o=!1,r=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);u>=n&&a>u&&r++}}),r>=i&&(o=!0),timeStart_hourValue=convert_Min2Hour(u),a+=n.replace(/:appointment_time_start/g,timeStart_hourValue),a=o?a.replace(":isScheduled",'disabled="disabled" style="color:red"'):a.replace(":isScheduled",""),u+=d}t.html(a)},"json").done(function(){t.fadeIn()})},"json")},"json").done(function(){if(i.hide(),d.show(),a){var e=o.find(".vus_time_start");e.css("color","#000"),o.modal("show")}else alert("Open editConfirmedAppointment popup error!")}),!1})},l=function(){r.on("submit",function(){var t=$(this),n=!1,a=t.find(".loading"),i=t.find(".done"),r=t.find(".b-service-not-exist");r.fadeOut(),a.fadeIn(),i.hide();var d=t.find(".appointment_date").val();d=moment(d,"DD-MM-YYYY");var _=convert_num2dayval(d.format("d")),c=null,u=URL+"spaCMS/calendar/xhrGet_user_open_hour";return $.get(u,function(d){if(c=d[_][0],!c)return r.fadeIn(),a.hide(),i.show(),!1;var u=(t.find('input[name="data_id"]').val(),t.find('input[name="appointment_date"]').val()),s=t.find('input[name="appointment_time_start"]').val(),d=t.serialize(),l=u+" "+s;$.ajax({url:URL+"spaCMS/calendar/xhrGetTimeAutoConfirmSpa",type:"post",data:{dateAppointment:l}}).done(function(t){var r=t,_=URL+"spaCMS/calendar/xhrUpdate_appointment";d+="&appointment_time_confirm="+r,$.post(_,d,function(e){"success"==e&&(n=!0)}).done(function(){a.hide(),i.show(),n?(o.modal("hide"),e.modal("hide"),jAlert("Cập nhật và gửi email thành công!")):alert("Update appointment error!")})})},"json"),!1}),i.on("click",function(){var t=$(this),n=e.find(".is_confirm_0"),a=e.find(".is_confirm_1"),o=!1,r=t.find(".loading"),d=t.find(".done"),_=t.attr("data_id"),u=t.attr("data_type"),s=t.attr("client_email");jConfirm("Xác thực lịch hẹn này?","Xác thực lịch hẹn",function(t){if(1==t){r.fadeIn(),d.hide();var l=URL+"spaCMS/calendar/xhrUpdate_appointment_is_confirm";$.post(l,{data_id:_,data_type:u,client_email:s},function(e){"success"==e&&(c(),o=!0)}).done(function(){r.hide(),d.show(),o?(n.hide(),a.hide(),a.fadeIn(),i.fadeOut(),e.modal("hide")):alert("Confirmed appointment error!")})}})}),a.on("click",function(){var o=$(this),r=o.attr("data_id"),d=o.attr("data_type"),_=!1,u=o.find(".loading"),s=o.find(".done");jConfirm("Bạn có chắc đã hoàn thành lịch hẹn này?","Hoàn thành lịch hẹn",function(o){if(1==o){u.fadeIn(),s.hide();var l=!1,p=URL+"spaCMS/calendar/xhrCheck_appointment_is_confirmed";$.post(p,{data_id:r,data_type:d},function(o){if("success"!=o)return!1;l=!0;var u=e.find(".status-uncomplete"),s=e.find(".status-complete"),p=e.find(".status-cancel"),m=URL+"spaCMS/calendar/xhrUpdate_appointment_status";$.post(m,{data_id:r,data_type:d},function(e){"success"==e&&(c(),_=!0)}).done(function(){_?(u.hide(),s.fadeIn(),p.hide(),a.fadeOut(),t.fadeOut(),n.fadeOut(),i.hide()):(u.fadeIn(),s.hide(),p.hide(),alert("Update appointment status error"))})}).done(function(){return u.hide(),s.show(),0==l?(alert("Chưa thể hoàn thành khi lịch hẹn của bạn chưa được xác thực!"),!1):void 0})}})})},p=function(){n.on("click",function(){var t=$(this),n=t.attr("data_id"),a=t.attr("data_type"),i={data_id:n,data_type:a},o=!1,r=t.find(".loading"),d=t.find(".done"),_="";if("booking_detail"==a){var u=t.attr("data_price"),s=parseInt(u)/1e4;_="Bạn có muốn hủy lịch hẹn này? <br/> Khách hàng sẽ nhận được "+s+" credit point."}else _="Bạn có muốn hủy lịch hẹn này?";return jConfirm(_,"Hủy lịch hẹn",function(t){if(1==t){r.fadeIn(),d.hide();var n=URL+"spaCMS/calendar/xhrDelete_appointment";$.post(n,i,function(e){"success"==e&&(c(),o=!0)}).done(function(){r.hide(),d.show(),o?e.modal("hide"):alert("Can not cancel appointment!")})}}),!1})},m=function(){var e=$("#editConfirmedAppointment_form").find(".edit_client_action"),t=$("#editClient_modal");e.on("click",function(){var e=$(this),n=e.attr("data_id"),a=e.attr("data_type"),i=!1,o=e.find(".e-loading");o.fadeIn();var r=null;return"appointment"==a?r=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==a&&(r=URL+"spaCMS/calendar/xhrGet_booking"),$.get(r,{data_id:n},function(e){if(0==e.length)return!1;i=!0;var o=$("input[name=client_name]",t),r=$("input[name=client_phone]",t),d=$("input[name=client_email]",t),_=$("input[name=client_sex]",t),c=$("input[name=client_birth]",t),u=$("textarea[name=client_note]",t);o.val(e[0].data_client_name),r.val(e[0].data_client_phone),d.val(e[0].data_client_email),_.filter('[value="'+e[0].data_client_sex+'"]').prop("checked",!0),c.val(e[0].data_client_birth),u.val(e[0].data_client_note),$("input[name=data_id]",t).val(n),$("input[name=data_type]",t).val(a)},"json").done(function(){o.hide(),i?t.modal("show"):alert("Can not open edit client form!")}),!1})},h=function(){var e=$("#editClient_modal"),t=$("#editConfirmedAppointment_form"),n=t.find(".client_name"),a=t.find(".client_phone"),i=t.find(".client_note"),o=t.find(".client_email");$("#editClient_form").on("submit",function(){var t=$(this),r=t.serialize(),d=!1,_=t.find(".loading"),u=t.find(".done");_.fadeIn(),u.hide();var s=URL+"spaCMS/calendar/xhrUpdate_appointment_client";return $.post(s,r,function(t){"success"==t&&(c(),n.hide(),a.hide(),i.hide(),o.hide(),n.text($("input[name=client_name]",e).val()),a.text($("input[name=client_phone]",e).val()),i.text($("textarea[name=client_note]",e).val()),o.text($("input[name=client_email]",e).val()),n.fadeIn(),a.fadeIn(),o.fadeIn(),i.fadeIn(),d=!0)}).done(function(){_.hide(),u.show(),d?e.modal("hide"):alert("Update client error!")}),!1})},f=function(){var e=$(".list_gus");e.html('<option value="">Chọn dịch vụ</option>');var t='<optgroup data-id=":group_service_id" label=":group_service_name">';t+=":list_user_service",t+="</optgroup>";var n='<option value=":user_service_id">:user_service_name</option>';n+=":list_user_service";var a=URL+"spaCMS/menu/xhrGet_group_user_service",i="",o=$.get(a,function(a){$.each(a,function(a,o){i=t.replace(":group_service_id",o.group_service_id),i=i.replace(":group_service_name",o.group_service_name),"undefined"!=typeof o.list_user_service&&$.each(o.list_user_service,function(e,t){i=i.replace(":list_user_service",n),i=i.replace(":user_service_id",t.user_service_id),i=i.replace(":user_service_name",t.user_service_name)}),i=i.replace(":list_user_service",""),e.append(i)})},"json");return o},v=function(){var e=o.find(".list_gus"),t=o.find(".appointment_time_start"),n=o.find(".user_service_duration"),a=$("input[name=appointment_price]",o),i=$("input[name=appointment_time_end]",o),d=o.find(".appointment_time_end"),_='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',c=null;e.on("change",function(){var e=$(this),r=o.find(".vus_time_start");r.css("color","#CCC");var u=e.val(),s=null,l=null,p=null,m=null;if(""===u)return!1;t.hide(),c="";var h=$("input[name=appointment_date]",o).val(),f=$("input[name=user_openHour]",o).val(),v=$("input[name=user_closeHour]",o).val(),g=URL+"spaCMS/calendar/xhrGet_user_service";$.get(g,{user_service_id:u},function(e){l=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,s=e[0].user_service_duration,s=parseInt(s);var n=60*f,a=60*v,r=n,g=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(g,{us_id:u,date:h},function(e){for(var t=e.user_service_limit_booking;a>r;){var n=!1,i=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);r>=n&&a>r&&i++}}),i>=t&&(n=!0),timeStart_hourValue=convert_Min2Hour(r),c+=_.replace(/:appointment_time_start/g,timeStart_hourValue),c=n?c.replace(":isScheduled",'disabled="disabled" style="color:red"'):c.replace(":isScheduled",""),r+=s}},"json").done(function(){t.html(c),t.fadeIn(),m=convert_Hour2Min(t.val()),p=convert_Min2Hour(m+s),d.text(p),i.val(p),$("input[name=appointment_time_start]",o).val(t.val())})},"json").done(function(){n.text(s),a.val(l)})}),o.find(".appointment_date").datepicker({language:"vi",autoclose:!0}).on("changeDate",function(){var e=$(this),u=e.val();""==u&&(u=$("input[name=appointment_date]").val(),u=moment(u,"YYYY-MM-DD"));var s=o.find(".vus_time_start");s.css("color","#CCC");var l=moment(u,"DD-MM-YYYY"),p=$("select[name=user_service_service_id]",r).val(),m=$("input[name=appointment_date]",o);m.val(l.format("YYYY-MM-DD")),t.hide(),c="";var h=convert_num2dayval(l.format("d")),f=null,v=null,g=null,M=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(M,function(e){if(f=e[h][0],v=e[h][1],g=e[h][2],!f)return alert("Không có lịch làm việc vào ngày này, hãy chọn ngày khác!"),!1;var r=($("input[name=user_openHour]",o).val(v),$("input[name=user_closeHour]",o).val(g),URL+"spaCMS/calendar/xhrGet_user_service");$.get(r,{user_service_id:p},function(e){us_price=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,us_duration=e[0].user_service_duration,us_duration=parseInt(us_duration);var n=60*v,a=60*g,r=n,u=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(u,{us_id:p,date:l.format("YYYY-MM-DD")},function(e){for(var t=e.user_service_limit_booking;a>r;){var n=!1,i=0;$.each(e,function(e,t){if("user_service_limit_booking"!=e){var n=convert_Hour2Min(t.schedule_time_start),a=convert_Hour2Min(t.schedule_time_end);r>=n&&a>r&&i++}}),i>=t&&(n=!0),timeStart_hourValue=convert_Min2Hour(r),c+=_.replace(/:appointment_time_start/g,timeStart_hourValue),c=n?c.replace(":isScheduled",'disabled="disabled" style="color:red"'):c.replace(":isScheduled",""),r+=us_duration}},"json").done(function(){t.html(c),t.fadeIn(),app_time_start=convert_Hour2Min(t.val()),app_time_end=convert_Min2Hour(app_time_start+us_duration),d.text(app_time_end),i.val(app_time_end),$("input[name=appointment_time_start]",o).val(t.val())})},"json").done(function(){n.text(us_duration),a.val(us_price)})},"json").done(function(){})}),$("body").removeClass("modal-open")},g=function(){var e=o.find(".appointment_time_start");e.change(function(){var e=$(this),t=e.val(),n=null;""==t&&(app_time_start_old=o.find(".user_service_time_start").text(),t=app_time_start_old);var a=o.find(".user_service_duration").text();a=parseInt(a);var i=convert_Hour2Min(t),r=i+a,n=convert_Min2Hour(r),d=o.find(".appointment_time_end");d.text(n),$("input[name=appointment_time_end]",o).val(n),$("input[name=appointment_time_start]",o).val(t)})};return{init:function(){d(),_(),c(),p(),s(),l(),m(),h(),f(),v(),g()}}}();